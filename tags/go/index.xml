<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Go on Biney&#39;s blog</title>
    <link>https://blog.mose.ltd/tags/go/</link>
    <description>Recent content in Go on Biney&#39;s blog</description>
    <generator>Hugo</generator>
    <language>en</language>
    <lastBuildDate>Fri, 11 Apr 2025 14:33:56 +0800</lastBuildDate>
    <atom:link href="https://blog.mose.ltd/tags/go/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Go Gin × MongoDB 性能优化记：把 p99 从 480ms 拉到 92ms</title>
      <link>https://blog.mose.ltd/posts/go-gin--mongodb-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E8%AE%B0%E6%8A%8A-p99-%E4%BB%8E-480ms-%E6%8B%89%E5%88%B0-92ms/</link>
      <pubDate>Fri, 11 Apr 2025 14:33:56 +0800</pubDate>
      <guid>https://blog.mose.ltd/posts/go-gin--mongodb-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E8%AE%B0%E6%8A%8A-p99-%E4%BB%8E-480ms-%E6%8B%89%E5%88%B0-92ms/</guid>
      <description>&lt;h1 id=&#34;go-gin--mongodb-性能优化记把-p99-从-480ms-拉到-92ms&#34;&gt;&lt;strong&gt;Go Gin × MongoDB 性能优化记：把 p99 从 480ms 拉到 92ms&lt;/strong&gt;&lt;/h1&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;这是一篇来自独立开发者后端的一线笔记：Molived（沉浸式观影榜单）与「不背成语」两个 App 共用同一套 Go + Gin + MongoDB 的 API。在一次晚高峰的抖动后，我们给这套系统做了系统性体检与优化。本文复盘方法、过程与落地方案，避免“经验之谈”的空泛，尽量用可复用的技术细节说话。&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;hr&gt;&#xA;&lt;h2 id=&#34;0-故事的起点晚八点的抖动&#34;&gt;&lt;strong&gt;0. 故事的起点：晚八点的抖动&lt;/strong&gt;&lt;/h2&gt;&#xA;&lt;p&gt;晚高峰（20:00–22:00）是 Molived 的自然流量峰值。一次发布后，观察到两条接口 &lt;strong&gt;p99 从 ~180ms 升到 480–600ms&lt;/strong&gt;：&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;/v1/movies/hotlist：带排序与筛选的内容列表。&lt;/li&gt;&#xA;&lt;li&gt;/v1/idioms/review/next：「不背成语」按 nextReviewAt 拉取下一个待复习批次。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;表面看起来是“数据库慢了”。但优化不是猜谜。我们的路线是：&lt;strong&gt;先度量 → 再定位 → 小步验证 → 渐进固化&lt;/strong&gt;。&lt;/p&gt;&#xA;&lt;hr&gt;&#xA;&lt;h2 id=&#34;1-先立度量与边界没有观测优化等于玄学&#34;&gt;&lt;strong&gt;1. 先立度量与边界：没有观测，优化等于玄学&lt;/strong&gt;&lt;/h2&gt;&#xA;&lt;h3 id=&#34;11-指标与追踪&#34;&gt;&lt;strong&gt;1.1 指标与追踪&lt;/strong&gt;&lt;/h3&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;strong&gt;延迟分位&lt;/strong&gt;：p50 / p90 / p95 / p99，接口与下游（Mongo）分别记录。&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;资源指标&lt;/strong&gt;：连接池（CheckedOut/CheckedIn）、等待队列、CPU/GC、goroutine。&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;追踪&lt;/strong&gt;：OpenTelemetry（Gin 中间件 + Mongo 驱动 hook）串起一次请求的全链路（反向代理 → Gin → 业务 → Mongo）。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h3 id=&#34;12-生产可用的最小观测集&#34;&gt;&lt;strong&gt;1.2 生产可用的最小观测集&lt;/strong&gt;&lt;/h3&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;strong&gt;pprof&lt;/strong&gt;：只在灰度与紧急定位时启用，避免常开带来的开销。&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;Explain Plan&lt;/strong&gt;：所有慢查询存证（抽样保存计划、扫描量、索引命中）。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;用这些，才能将“感觉”变成“证据”。&lt;/p&gt;</description>
    </item>
    <item>
      <title>从 Python(Flask) 到 Go(Gin)：一段后端“换舵记”</title>
      <link>https://blog.mose.ltd/posts/%E4%BB%8E-pythonflask-%E5%88%B0-gogin%E4%B8%80%E6%AE%B5%E5%90%8E%E7%AB%AF%E6%8D%A2%E8%88%B5%E8%AE%B0/</link>
      <pubDate>Thu, 21 Mar 2019 14:33:56 +0800</pubDate>
      <guid>https://blog.mose.ltd/posts/%E4%BB%8E-pythonflask-%E5%88%B0-gogin%E4%B8%80%E6%AE%B5%E5%90%8E%E7%AB%AF%E6%8D%A2%E8%88%B5%E8%AE%B0/</guid>
      <description>&lt;h1 id=&#34;从-pythonflask-到-gogin一段后端换舵记&#34;&gt;&lt;strong&gt;从 Python(Flask) 到 Go(Gin)：一段后端“换舵记”&lt;/strong&gt;&lt;/h1&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;半夜 1:40，报警短信把我从椅子上拽起来：P95 突然升到 800ms。机房的风像打鼓，Gunicorn 的 worker 数往上拧了一圈又一圈。请求还是像涨潮一样涌进来。我盯着那条最慢的接口，心里第一次冒出一句话：&lt;strong&gt;也许我需要一门更像“发动机”的语言。&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;hr&gt;&#xA;&lt;h2 id=&#34;起风瓶颈并不是写得不够优雅&#34;&gt;&lt;strong&gt;起风｜瓶颈并不是“写得不够优雅”&lt;/strong&gt;&lt;/h2&gt;&#xA;&lt;p&gt;那一夜复盘，结论很俗，但很实在：&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;strong&gt;并发模型不投缘&lt;/strong&gt;：WSGI 下我靠多进程/多线程把吞吐“堆”上去，GIL 没直接卡住 IO，但上下文切换和序列化成了隐形税。&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;序列化成本&lt;/strong&gt;：Pydantic + json.dumps 在热路径上很勤奋，也很“费力”。&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;连接管理&lt;/strong&gt;：SQLAlchemy 的池子我调到 50 了，还是能遇到偶发的“闸门”，而它恰好发生在流量波峰。&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;部署心智&lt;/strong&gt;：虚拟环境、系统依赖、C 扩展版本匹配。不是不能治，只是治起来像老房子翻修。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;那晚我关掉了最后一个 worker 的扩容策略，给自己立了个规矩：&lt;strong&gt;下一个迭代，我做一个平行实现，用 Go 的 Gin 把那条最慢接口写出来，直到数字说话。&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;hr&gt;&#xA;&lt;h2 id=&#34;换舵为什么是-gin&#34;&gt;&lt;strong&gt;换舵｜为什么是 Gin&lt;/strong&gt;&lt;/h2&gt;&#xA;&lt;p&gt;不想搞“主义”，只说对我这类 API 服务的&lt;strong&gt;顺手&lt;/strong&gt;：&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;strong&gt;轻，直接&lt;/strong&gt;：net/http 起手，Gin 只是在路由和中间件上给了舒服的壳。&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;并发像呼吸一样自然&lt;/strong&gt;：goroutine + channel，把“等数据库”和“等下游”的时间让出来。&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;可观察性开箱即用&lt;/strong&gt;：pprof、expvar、runtime/trace，定位抖动不用再绕弯。&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;交付简单&lt;/strong&gt;：一个静态二进制，容器镜像从 600MB 瘦到几十 MB，冷启动更短。&lt;/li&gt;&#xA;&lt;li&gt;&lt;strong&gt;类型系统&lt;/strong&gt;：对协议收敛、边界清单特别友好（尤其配合 OpenAPI 做契约测试）。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;我不是抛弃 Python。它仍然是脚本、工具、离线处理与快速检验的王。只是“这台发动机”，Go 更贴合。&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;hr&gt;&#xA;&lt;h2 id=&#34;工地现场我把最慢接口抠了两遍&#34;&gt;&lt;strong&gt;工地现场｜我把最慢接口抠了两遍&lt;/strong&gt;&lt;/h2&gt;&#xA;&lt;h3 id=&#34;flask-版本化简后&#34;&gt;&lt;strong&gt;Flask 版本（化简后）&lt;/strong&gt;&lt;/h3&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-python&#34; data-lang=&#34;python&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#6272a4&#34;&gt;# app.py&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff79c6&#34;&gt;from&lt;/span&gt; flask &lt;span style=&#34;color:#ff79c6&#34;&gt;import&lt;/span&gt; Flask, request, jsonify&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff79c6&#34;&gt;from&lt;/span&gt; models &lt;span style=&#34;color:#ff79c6&#34;&gt;import&lt;/span&gt; Session, Item&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff79c6&#34;&gt;from&lt;/span&gt; schemas &lt;span style=&#34;color:#ff79c6&#34;&gt;import&lt;/span&gt; ItemOut  &lt;span style=&#34;color:#6272a4&#34;&gt;# pydantic&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;app &lt;span style=&#34;color:#ff79c6&#34;&gt;=&lt;/span&gt; Flask(__name__)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;@app.route(&lt;span style=&#34;color:#f1fa8c&#34;&gt;&amp;#34;/v1/items/&amp;lt;int:item_id&amp;gt;&amp;#34;&lt;/span&gt;, methods&lt;span style=&#34;color:#ff79c6&#34;&gt;=&lt;/span&gt;[&lt;span style=&#34;color:#f1fa8c&#34;&gt;&amp;#34;GET&amp;#34;&lt;/span&gt;])&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#ff79c6&#34;&gt;def&lt;/span&gt; &lt;span style=&#34;color:#50fa7b&#34;&gt;get_item&lt;/span&gt;(item_id):&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    user_id &lt;span style=&#34;color:#ff79c6&#34;&gt;=&lt;/span&gt; request&lt;span style=&#34;color:#ff79c6&#34;&gt;.&lt;/span&gt;headers&lt;span style=&#34;color:#ff79c6&#34;&gt;.&lt;/span&gt;get(&lt;span style=&#34;color:#f1fa8c&#34;&gt;&amp;#34;X-User&amp;#34;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#ff79c6&#34;&gt;with&lt;/span&gt; Session() &lt;span style=&#34;color:#ff79c6&#34;&gt;as&lt;/span&gt; s:&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        row &lt;span style=&#34;color:#ff79c6&#34;&gt;=&lt;/span&gt; s&lt;span style=&#34;color:#ff79c6&#34;&gt;.&lt;/span&gt;query(Item)&lt;span style=&#34;color:#ff79c6&#34;&gt;.&lt;/span&gt;filter(Item&lt;span style=&#34;color:#ff79c6&#34;&gt;.&lt;/span&gt;id&lt;span style=&#34;color:#ff79c6&#34;&gt;==&lt;/span&gt;item_id, Item&lt;span style=&#34;color:#ff79c6&#34;&gt;.&lt;/span&gt;user_id&lt;span style=&#34;color:#ff79c6&#34;&gt;==&lt;/span&gt;user_id)&lt;span style=&#34;color:#ff79c6&#34;&gt;.&lt;/span&gt;one_or_none()&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#ff79c6&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#ff79c6&#34;&gt;not&lt;/span&gt; row:&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#ff79c6&#34;&gt;return&lt;/span&gt; jsonify({&lt;span style=&#34;color:#f1fa8c&#34;&gt;&amp;#34;error&amp;#34;&lt;/span&gt;:&lt;span style=&#34;color:#f1fa8c&#34;&gt;&amp;#34;not_found&amp;#34;&lt;/span&gt;}), &lt;span style=&#34;color:#bd93f9&#34;&gt;404&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        data &lt;span style=&#34;color:#ff79c6&#34;&gt;=&lt;/span&gt; ItemOut&lt;span style=&#34;color:#ff79c6&#34;&gt;.&lt;/span&gt;from_orm(row)&lt;span style=&#34;color:#ff79c6&#34;&gt;.&lt;/span&gt;dict()&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#ff79c6&#34;&gt;return&lt;/span&gt; jsonify(data), &lt;span style=&#34;color:#bd93f9&#34;&gt;200&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;gin-版本等价功能&#34;&gt;&lt;strong&gt;Gin 版本（等价功能）&lt;/strong&gt;&lt;/h3&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#6272a4&#34;&gt;// main.go&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#6272a4&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#8be9fd;font-style:italic&#34;&gt;type&lt;/span&gt; Item &lt;span style=&#34;color:#8be9fd;font-style:italic&#34;&gt;struct&lt;/span&gt; {&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    ID     &lt;span style=&#34;color:#8be9fd&#34;&gt;int64&lt;/span&gt;  &lt;span style=&#34;color:#f1fa8c&#34;&gt;`db:&amp;#34;id&amp;#34; json:&amp;#34;id&amp;#34;`&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    UserID &lt;span style=&#34;color:#8be9fd&#34;&gt;int64&lt;/span&gt;  &lt;span style=&#34;color:#f1fa8c&#34;&gt;`db:&amp;#34;user_id&amp;#34; json:&amp;#34;-&amp;#34;`&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    Name   &lt;span style=&#34;color:#8be9fd&#34;&gt;string&lt;/span&gt; &lt;span style=&#34;color:#f1fa8c&#34;&gt;`db:&amp;#34;name&amp;#34; json:&amp;#34;name&amp;#34;`&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    Ctime  &lt;span style=&#34;color:#8be9fd&#34;&gt;int64&lt;/span&gt;  &lt;span style=&#34;color:#f1fa8c&#34;&gt;`db:&amp;#34;ctime&amp;#34; json:&amp;#34;ctime&amp;#34;`&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#8be9fd;font-style:italic&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#50fa7b&#34;&gt;getItem&lt;/span&gt;(db &lt;span style=&#34;color:#ff79c6&#34;&gt;*&lt;/span&gt;sqlx.DB) gin.HandlerFunc {&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#ff79c6&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color:#8be9fd;font-style:italic&#34;&gt;func&lt;/span&gt;(c &lt;span style=&#34;color:#ff79c6&#34;&gt;*&lt;/span&gt;gin.Context) {&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        itemID, _ &lt;span style=&#34;color:#ff79c6&#34;&gt;:=&lt;/span&gt; strconv.&lt;span style=&#34;color:#50fa7b&#34;&gt;ParseInt&lt;/span&gt;(c.&lt;span style=&#34;color:#50fa7b&#34;&gt;Param&lt;/span&gt;(&lt;span style=&#34;color:#f1fa8c&#34;&gt;&amp;#34;item_id&amp;#34;&lt;/span&gt;), &lt;span style=&#34;color:#bd93f9&#34;&gt;10&lt;/span&gt;, &lt;span style=&#34;color:#bd93f9&#34;&gt;64&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        userID, _ &lt;span style=&#34;color:#ff79c6&#34;&gt;:=&lt;/span&gt; strconv.&lt;span style=&#34;color:#50fa7b&#34;&gt;ParseInt&lt;/span&gt;(c.&lt;span style=&#34;color:#50fa7b&#34;&gt;GetHeader&lt;/span&gt;(&lt;span style=&#34;color:#f1fa8c&#34;&gt;&amp;#34;X-User&amp;#34;&lt;/span&gt;), &lt;span style=&#34;color:#bd93f9&#34;&gt;10&lt;/span&gt;, &lt;span style=&#34;color:#bd93f9&#34;&gt;64&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        ctx, cancel &lt;span style=&#34;color:#ff79c6&#34;&gt;:=&lt;/span&gt; context.&lt;span style=&#34;color:#50fa7b&#34;&gt;WithTimeout&lt;/span&gt;(c.Request.&lt;span style=&#34;color:#50fa7b&#34;&gt;Context&lt;/span&gt;(), &lt;span style=&#34;color:#bd93f9&#34;&gt;500&lt;/span&gt;&lt;span style=&#34;color:#ff79c6&#34;&gt;*&lt;/span&gt;time.Millisecond)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#ff79c6&#34;&gt;defer&lt;/span&gt; &lt;span style=&#34;color:#50fa7b&#34;&gt;cancel&lt;/span&gt;()&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#8be9fd;font-style:italic&#34;&gt;var&lt;/span&gt; it Item&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        err &lt;span style=&#34;color:#ff79c6&#34;&gt;:=&lt;/span&gt; db.&lt;span style=&#34;color:#50fa7b&#34;&gt;GetContext&lt;/span&gt;(ctx, &lt;span style=&#34;color:#ff79c6&#34;&gt;&amp;amp;&lt;/span&gt;it,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#f1fa8c&#34;&gt;`SELECT id,user_id,name,ctime FROM items WHERE id=? AND user_id=?`&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            itemID, userID)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#ff79c6&#34;&gt;if&lt;/span&gt; err &lt;span style=&#34;color:#ff79c6&#34;&gt;==&lt;/span&gt; sql.ErrNoRows {&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            c.&lt;span style=&#34;color:#50fa7b&#34;&gt;JSON&lt;/span&gt;(http.StatusNotFound, gin.H{&lt;span style=&#34;color:#f1fa8c&#34;&gt;&amp;#34;error&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#f1fa8c&#34;&gt;&amp;#34;not_found&amp;#34;&lt;/span&gt;})&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#ff79c6&#34;&gt;return&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        } &lt;span style=&#34;color:#ff79c6&#34;&gt;else&lt;/span&gt; &lt;span style=&#34;color:#ff79c6&#34;&gt;if&lt;/span&gt; err &lt;span style=&#34;color:#ff79c6&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#ff79c6&#34;&gt;nil&lt;/span&gt; {&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            c.&lt;span style=&#34;color:#50fa7b&#34;&gt;JSON&lt;/span&gt;(http.StatusServiceUnavailable, gin.H{&lt;span style=&#34;color:#f1fa8c&#34;&gt;&amp;#34;error&amp;#34;&lt;/span&gt;: &lt;span style=&#34;color:#f1fa8c&#34;&gt;&amp;#34;db_unavailable&amp;#34;&lt;/span&gt;})&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#ff79c6&#34;&gt;return&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        }&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        c.&lt;span style=&#34;color:#50fa7b&#34;&gt;JSON&lt;/span&gt;(http.StatusOK, it)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#8be9fd;font-style:italic&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#50fa7b&#34;&gt;main&lt;/span&gt;() {&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    r &lt;span style=&#34;color:#ff79c6&#34;&gt;:=&lt;/span&gt; gin.&lt;span style=&#34;color:#50fa7b&#34;&gt;New&lt;/span&gt;()&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    r.&lt;span style=&#34;color:#50fa7b&#34;&gt;Use&lt;/span&gt;(gin.&lt;span style=&#34;color:#50fa7b&#34;&gt;Recovery&lt;/span&gt;(), &lt;span style=&#34;color:#50fa7b&#34;&gt;requestLogger&lt;/span&gt;(), &lt;span style=&#34;color:#50fa7b&#34;&gt;prometheusMiddleware&lt;/span&gt;())&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    db &lt;span style=&#34;color:#ff79c6&#34;&gt;:=&lt;/span&gt; sqlx.&lt;span style=&#34;color:#50fa7b&#34;&gt;MustConnect&lt;/span&gt;(&lt;span style=&#34;color:#f1fa8c&#34;&gt;&amp;#34;mysql&amp;#34;&lt;/span&gt;, os.&lt;span style=&#34;color:#50fa7b&#34;&gt;Getenv&lt;/span&gt;(&lt;span style=&#34;color:#f1fa8c&#34;&gt;&amp;#34;DSN&amp;#34;&lt;/span&gt;))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    r.&lt;span style=&#34;color:#50fa7b&#34;&gt;GET&lt;/span&gt;(&lt;span style=&#34;color:#f1fa8c&#34;&gt;&amp;#34;/v1/items/:item_id&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#50fa7b&#34;&gt;getItem&lt;/span&gt;(db))&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    _ = r.&lt;span style=&#34;color:#50fa7b&#34;&gt;Run&lt;/span&gt;(&lt;span style=&#34;color:#f1fa8c&#34;&gt;&amp;#34;:8080&amp;#34;&lt;/span&gt;)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;差别感受（真实开发里的手感）&lt;/strong&gt;&lt;/p&gt;</description>
    </item>
  </channel>
</rss>
